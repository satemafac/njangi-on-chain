(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[189],{7533:(e,t,i)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/circle/[id]/join",function(){return i(583)}])},583:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>y});var c=i(4848),r=i(6540),s=i(6715),o=i(3481),n=i(3787),a=i(3741),l=i(2636),d=i(1895),u=i(2876),m=i(6753),h=i(6857);function y(){let e=(0,s.useRouter)(),{id:t}=e.query,{isAuthenticated:i,userAddress:y,account:b}=(0,o.A)(),[p,g]=(0,r.useState)(!0),[f,x]=(0,r.useState)(null),[_,v]=(0,r.useState)(!1),[N,j]=(0,r.useState)(!1),[w,U]=(0,r.useState)(!1),[S,A]=(0,r.useState)(1.25);(0,r.useEffect)(()=>{if(!i){e.push("/");return}},[i,e]),(0,r.useEffect)(()=>{(async()=>{try{let e=await u.n.getSUIPrice();e&&!isNaN(e)&&e>0&&(A(e),console.log("Fetched SUI price:",e))}catch(e){console.error("Error fetching SUI price:",e)}})()},[]),(0,r.useEffect)(()=>{t&&y&&P()},[t,y]),(0,r.useEffect)(()=>{t&&y&&C()},[t,y]),(0,r.useEffect)(()=>{if(t){P();try{let e=localStorage.getItem("viewedCircles"),i=[];e&&(i=JSON.parse(e)),i.includes(t)||(i.push(t),localStorage.setItem("viewedCircles",JSON.stringify(i)))}catch(e){console.error("Error storing circle ID in localStorage:",e)}}},[t,y]);let P=async()=>{if(t){console.log("Join - Fetching circle details for:",t),g(!0);try{var i,c,r,s,o,n;let a,u;let m=new d.x({url:"https://fullnode.testnet.sui.io:443"}),b=await m.getObject({id:t,options:{showContent:!0,showType:!0}});if(!(null===(i=b.data)||void 0===i?void 0:i.content)||!("fields"in b.data.content))throw Error("Invalid circle object data received");let p=b.data.content.fields;console.log("Join - Raw Circle Object Fields:",p);let g=(await m.getDynamicFields({parentId:t})).data;console.log("Join - Dynamic Fields:",g);try{let e=(await m.queryEvents({query:{MoveEventType:"".concat(h.j,"::njangi_circles::CircleCreated")},limit:50})).data.find(e=>{var i;return(null===(i=e.parsedJson)||void 0===i?void 0:i.circle_id)===t});if(console.log("Join - Found creation event:",!!e),(null==e?void 0:e.parsedJson)&&(u=e.parsedJson),null==e?void 0:null===(c=e.id)||void 0===c?void 0:c.txDigest){let t=await m.getTransactionBlock({digest:e.id.txDigest,options:{showInput:!0}});if(console.log("Join - Transaction data fetched:",!!t),(null==t?void 0:null===(o=t.transaction)||void 0===o?void 0:null===(s=o.data)||void 0===s?void 0:null===(r=s.transaction)||void 0===r?void 0:r.kind)==="ProgrammableTransaction"){let e=t.transaction.data.transaction.inputs||[];console.log("Join - Transaction inputs:",e),e.length>6&&"pure"===e[6].type&&"u64"===e[6].valueType&&(a={cycle_day:Number(e[6].value)},console.log("Join - Found cycle_day ".concat(a.cycle_day," from tx")))}}}catch(e){console.error("Join - Error fetching event/transaction data:",e)}let f={contributionAmount:0,contributionAmountUsd:0,securityDeposit:0,securityDepositUsd:0,cycleLength:0,cycleDay:1,maxMembers:3};for(let e of(u&&(u.contribution_amount&&(f.contributionAmount=Number(u.contribution_amount)/1e9),u.contribution_amount_usd&&(f.contributionAmountUsd=Number(u.contribution_amount_usd)/100),u.security_deposit_usd&&(f.securityDepositUsd=Number(u.security_deposit_usd)/100),u.cycle_length&&(f.cycleLength=Number(u.cycle_length)),u.max_members&&(f.maxMembers=Number(u.max_members))),(null==a?void 0:a.cycle_day)!==void 0&&(f.cycleDay=a.cycle_day),console.log("Join - Config after Tx/Event:",f),g)){if(!e)continue;let t=!1;if((e.name&&"object"==typeof e.name&&"value"in e.name&&"circle_config"===e.name.value||e.type&&"string"==typeof e.type&&e.type.includes("CircleConfig"))&&(t=!0),t&&e.objectId){console.log("Join - Found CircleConfig dynamic field object:",e.objectId);try{let t=await m.getObject({id:e.objectId,options:{showContent:!0}});if(console.log("Join - Config object content:",t),(null===(n=t.data)||void 0===n?void 0:n.content)&&"fields"in t.data.content){let e=t.data.content.fields;void 0!==e.contribution_amount&&(f.contributionAmount=Number(e.contribution_amount)/1e9),void 0!==e.contribution_amount_usd&&(f.contributionAmountUsd=Number(e.contribution_amount_usd)/100),void 0!==e.security_deposit&&(f.securityDeposit=Number(e.security_deposit)/1e9),void 0!==e.security_deposit_usd&&(f.securityDepositUsd=Number(e.security_deposit_usd)/100),void 0!==e.cycle_length&&(f.cycleLength=Number(e.cycle_length)),void 0!==e.cycle_day&&(f.cycleDay=Number(e.cycle_day)),void 0!==e.max_members&&(f.maxMembers=Number(e.max_members))}}catch(t){console.error("Join - Error fetching config object ".concat(e.objectId,":"),t)}break}}console.log("Join - Config after Dynamic Fields:",f),0===f.contributionAmount&&p.contribution_amount&&(f.contributionAmount=Number(p.contribution_amount)/1e9),0===f.contributionAmountUsd&&p.contribution_amount_usd&&(f.contributionAmountUsd=Number(p.contribution_amount_usd)/100),0===f.securityDeposit&&p.security_deposit&&(f.securityDeposit=Number(p.security_deposit)/1e9),0===f.securityDepositUsd&&p.security_deposit_usd&&(f.securityDepositUsd=Number(p.security_deposit_usd)/100),0!==f.cycleLength||void 0===p.cycle_length||isNaN(Number(p.cycle_length))||(f.cycleLength=Number(p.cycle_length)),1!==f.cycleDay||void 0===p.cycle_day||isNaN(Number(p.cycle_day))||(f.cycleDay=Number(p.cycle_day)),3!==f.maxMembers||void 0===p.max_members||isNaN(Number(p.max_members))||(f.maxMembers=Number(p.max_members)),console.log("Join - Config after Direct Fields Fallback:",f);let _=S>0?S:1;0===f.contributionAmount&&f.contributionAmountUsd>0&&(f.contributionAmount=f.contributionAmountUsd/_,console.log("Join - Calculated contribution SUI from USD: ".concat(f.contributionAmount))),0===f.securityDeposit&&f.securityDepositUsd>0&&(f.securityDeposit=f.securityDepositUsd/_,console.log("Join - Calculated security deposit SUI from USD: ".concat(f.securityDeposit)));let v=p.admin===y;if(j(v),v){(0,l.oR)("You are the admin of this circle."),e.push("/circle/".concat(t));return}let N=1;try{let i=await m.queryEvents({query:{MoveEventType:"".concat(h.j,"::njangi_circles::MemberJoined")},limit:1e3}),c=new Set;if(c.add(p.admin),i.data.forEach(e=>{var i,r;(null===(i=e.parsedJson)||void 0===i?void 0:i.circle_id)===t&&(null===(r=e.parsedJson)||void 0===r?void 0:r.member)&&c.add(e.parsedJson.member)}),N=c.size,console.log("Join - Final member count: ".concat(N)),y&&c.has(y)){console.log("Join - User is already a member based on event query."),j(!0),(0,l.oR)("You are already a member of this circle."),e.push("/circle/".concat(t));return}}catch(e){console.error("Join - Error fetching member count for circle ".concat(t,":"),e),N=Number(p.current_members||1)}x({id:t,name:"string"==typeof p.name?p.name:"",admin:"string"==typeof p.admin?p.admin:"",contributionAmount:f.contributionAmount,contributionAmountUsd:f.contributionAmountUsd,securityDeposit:f.securityDeposit,securityDepositUsd:f.securityDepositUsd,cycleLength:f.cycleLength,cycleDay:f.cycleDay,maxMembers:f.maxMembers,currentMembers:N,nextPayoutTime:Number(p.next_payout_time||0)})}catch(e){console.error("Join - Error fetching circle details:",e),l.oR.error("Could not load circle information")}finally{g(!1)}}},C=async()=>{if(t&&y)try{let e=await m.A.checkPendingRequest(t,y);U(e)}catch(e){console.error("Error checking pending requests:",e)}},D=async()=>{if(f&&y){v(!0);try{await m.A.createJoinRequest(f.id,f.name,y,(null==b?void 0:b.name)||"Unknown User")?(U(!0),l.oR.success("Your request to join has been sent to the admin!")):l.oR.error("Failed to send join request")}catch(e){console.error("Error sending join request:",e),l.oR.error("Failed to send join request")}finally{v(!1)}}},I=(e,t)=>{let i="",c="",r="number"==typeof e?e:0,s="number"==typeof t?t:0,o=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];switch((0===r||3===r)&&s>6&&(s=0),(1===r||2===r)&&(s<=0||s>28)&&(s=1),r){case 0:i="Weekly",c=o[s]||"Monday";break;case 3:i="Bi-Weekly",c=o[s]||"Monday";break;case 1:i="Monthly",c=E(s);break;case 2:i="Quarterly",c=E(s);break;default:i="Unknown",c="Day ".concat(0===s?1:s)}return 1===r||2===r?"".concat(i," (").concat(c.replace(" day",""),")"):"".concat(i," (").concat(c,")")},E=e=>{let t=e%100,i=t>=11&&t<=13?"th":["th","st","nd","rd"][Math.min(t%10,3)];return"".concat(e).concat(i," day")},J=e=>e&&S&&!(S<=0)?e/S:0,F=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(e),k=e=>{let t,{usd:i,sui:r,className:s=""}=e,o=void 0===i||isNaN(i)?0:i,n=(t=void 0!==r&&!isNaN(r)&&r<1e6?r:o&&S>0?o/S:0)>=1e3?t.toLocaleString("en-US",{maximumFractionDigits:0}):t.toLocaleString("en-US",{maximumFractionDigits:2});return(0,c.jsxs)("div",{className:"flex flex-col ".concat(s),children:[(0,c.jsx)("span",{className:"font-medium",children:F(o)}),(0,c.jsxs)("span",{className:"text-sm text-gray-500",children:[n," SUI"]})]})};return i&&b?(0,c.jsx)("div",{className:"min-h-screen bg-gray-50",children:(0,c.jsx)("main",{className:"max-w-7xl mx-auto py-6 sm:px-6 lg:px-8",children:(0,c.jsxs)("div",{className:"px-4 py-6 sm:px-0",children:[(0,c.jsx)("div",{className:"mb-6",children:(0,c.jsxs)("button",{onClick:()=>e.push("/dashboard"),className:"inline-flex items-center gap-1.5 px-4 py-2 rounded-full bg-white border border-gray-200 hover:bg-gray-50 hover:border-gray-300 transition-all shadow-sm text-sm text-gray-700 font-medium",children:[(0,c.jsx)(n.A,{className:"w-4 h-4"}),"Back to Dashboard"]})}),(0,c.jsx)("div",{className:"bg-white shadow-md rounded-xl overflow-hidden border border-gray-100",children:(0,c.jsxs)("div",{className:"p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50",children:[(0,c.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:"Join Circle"}),p?(0,c.jsx)("div",{className:"py-8 flex justify-center",children:(0,c.jsxs)("svg",{className:"animate-spin h-8 w-8 text-blue-500",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,c.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,c.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}):f?(0,c.jsxs)("div",{className:"py-4 space-y-8",children:[(0,c.jsxs)("div",{className:"px-2",children:[(0,c.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4 border-l-4 border-blue-500 pl-3",children:"Circle Details"}),(0,c.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,c.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg shadow-sm",children:[(0,c.jsx)("p",{className:"text-sm text-gray-500 mb-1",children:"Circle Name"}),(0,c.jsx)("p",{className:"text-lg font-medium",children:f.name})]}),(0,c.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg shadow-sm",children:[(0,c.jsx)("p",{className:"text-sm text-gray-500 mb-1",children:"Contribution Amount"}),(0,c.jsx)(k,{usd:f.contributionAmountUsd,sui:f.contributionAmount})]}),(0,c.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg shadow-sm",children:[(0,c.jsx)("p",{className:"text-sm text-gray-500 mb-1",children:"Security Deposit"}),(0,c.jsx)(k,{usd:f.securityDepositUsd,sui:f.securityDeposit})]}),(0,c.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg shadow-sm",children:[(0,c.jsx)("p",{className:"text-sm text-gray-500 mb-1",children:"Contribution Schedule"}),(0,c.jsx)("p",{className:"text-lg font-medium",children:I(f.cycleLength,f.cycleDay)})]}),(0,c.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg shadow-sm",children:[(0,c.jsx)("p",{className:"text-sm text-gray-500 mb-1",children:"Members"}),(0,c.jsxs)("p",{className:"text-lg font-medium",children:[f.currentMembers," / ",f.maxMembers]})]})]})]}),(0,c.jsxs)("div",{className:"pt-6 border-t border-gray-200 px-2",children:[(0,c.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4 border-l-4 border-blue-500 pl-3",children:"Join Request"}),(0,c.jsx)("div",{className:"bg-yellow-50 p-4 rounded-md mb-6",children:(0,c.jsxs)("p",{className:"text-sm text-yellow-800",children:["By joining this circle, you agree to contribute ",F(f.contributionAmountUsd)," (",J(f.contributionAmountUsd).toLocaleString()," SUI) ",I(f.cycleLength,f.cycleDay).toLowerCase(),". You will also need to pay a security deposit of ",F(f.securityDepositUsd)," (",J(f.securityDepositUsd).toLocaleString()," SUI)."]})}),w?(0,c.jsxs)("div",{className:"bg-blue-50 p-4 rounded-md mb-6 flex items-start",children:[(0,c.jsx)(a.A,{className:"w-5 h-5 text-blue-500 mr-2 flex-shrink-0 mt-0.5"}),(0,c.jsxs)("div",{children:[(0,c.jsx)("h4",{className:"text-sm font-medium text-blue-800",children:"Request Sent"}),(0,c.jsx)("p",{className:"text-sm text-blue-700 mt-1",children:"Your request to join this circle has been sent to the admin. You'll be notified when your request is approved."})]})]}):(0,c.jsx)("button",{onClick:D,disabled:_||N||w,className:"w-full flex justify-center py-3 px-4 rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 transition-all ".concat(_||N||w?"opacity-70 cursor-not-allowed":""),children:_?"Sending Request...":N?"Already a Member":"Request to Join Circle"})]})]}):(0,c.jsx)("div",{className:"py-8 text-center",children:(0,c.jsx)("p",{className:"text-gray-500",children:"Circle not found"})})]})})]})})}):null}},6857:(e,t,i)=>{"use strict";i.d(t,{j:()=>c});let c="0xd530bfd7511ac2d343646a8ca4e2e14ffb89e1ec69a38ff8fb99c415706d6154"},2876:(e,t,i)=>{"use strict";i.d(t,{n:()=>r});class c{static getInstance(){return c.instance||(c.instance=new c),c.instance}loadCachedPrice(){{let e=localStorage.getItem(this.STORAGE_KEY);if(e)try{let{price:t,timestamp:i}=JSON.parse(e);this.cachedPrice=t,this.lastFetchTime=i}catch(e){console.error("Error parsing cached price data:",e)}}}saveCachedPrice(e,t){localStorage.setItem(this.STORAGE_KEY,JSON.stringify({price:e,timestamp:t}))}getFetchStatus(){return this.fetchStatus}isPriceAvailable(){return null!==this.cachedPrice}getCachedPrice(){return this.cachedPrice}async forceRefreshPrice(){return this.lastFetchTime=0,this.getSUIPrice()}async fetchBinancePrice(){try{let e=await fetch(this.BINANCE_API_URL);if(!e.ok)throw Error("Failed to fetch from Binance");let t=await e.json();if(t&&t.price)return parseFloat(t.price);return null}catch(e){return console.error("Error fetching from Binance:",e),null}}async fetchJupiterPrice(){try{let e=await fetch(this.BACKUP_API_URL);if(!e.ok)throw Error("Failed to fetch from Jupiter");let t=await e.json();if(t&&t.data&&t.data.SUI)return t.data.SUI.price;return null}catch(e){return console.error("Error fetching from Jupiter:",e),null}}async getSUIPrice(){let e=Date.now();if(null!==this.cachedPrice&&e-this.lastFetchTime<this.CACHE_DURATION)return console.log("Using cached SUI price: $".concat(this.cachedPrice," (").concat(Math.floor((e-this.lastFetchTime)/1e3),"s old)")),this.cachedPrice;this.fetchStatus="loading";try{let t=await fetch(this.PRIMARY_API_URL);if(!t.ok)throw Error("Failed to fetch SUI price from primary API");let i=await t.json();return this.cachedPrice=i.sui.usd,this.lastFetchTime=e,this.saveCachedPrice(this.cachedPrice,e),this.fetchStatus="success",console.log("Successfully fetched fresh SUI price: $".concat(this.cachedPrice)),this.cachedPrice}catch(c){console.error("Error fetching SUI price from primary API:",c);let t=await this.fetchJupiterPrice();if(null!==t)return this.cachedPrice=t,this.lastFetchTime=e,this.saveCachedPrice(this.cachedPrice,e),this.fetchStatus="success",console.log("Successfully fetched SUI price from Jupiter: $".concat(this.cachedPrice)),this.cachedPrice;let i=await this.fetchBinancePrice();if(null!==i)return this.cachedPrice=i,this.lastFetchTime=e,this.saveCachedPrice(this.cachedPrice,e),this.fetchStatus="success",console.log("Successfully fetched SUI price from Binance: $".concat(this.cachedPrice)),this.cachedPrice;if(this.fetchStatus="error",null!==this.cachedPrice&&e-this.lastFetchTime<216e5)return console.warn("Using stale cached price: $".concat(this.cachedPrice)),this.cachedPrice;return(null===this.cachedPrice||e-this.lastFetchTime>216e5)&&(console.warn("Using fallback price: $".concat(this.FALLBACK_PRICE)),this.cachedPrice=this.FALLBACK_PRICE,this.lastFetchTime=e,this.saveCachedPrice(this.cachedPrice,e)),this.cachedPrice}}constructor(){this.lastFetchTime=0,this.cachedPrice=null,this.CACHE_DURATION=3e5,this.PRIMARY_API_URL="https://api.coingecko.com/api/v3/simple/price?ids=sui&vs_currencies=usd",this.BACKUP_API_URL="https://price.jup.ag/v4/price?ids=SUI",this.BINANCE_API_URL="https://api.binance.com/api/v3/ticker/price?symbol=SUIUSDT",this.STORAGE_KEY="sui_cached_price",this.FALLBACK_PRICE=3.71,this.fetchStatus="idle",this.loadCachedPrice()}}let r=c.getInstance()},3787:(e,t,i)=>{"use strict";i.d(t,{A:()=>c});let c=(0,i(9279).A)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]])},3741:(e,t,i)=>{"use strict";i.d(t,{A:()=>c});let c=(0,i(9279).A)("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]])}},e=>{var t=t=>e(e.s=t);e.O(0,[895,636,593,792],()=>t(7533)),_N_E=e.O()}]);